using System;
using System.Drawing;
using System.Windows.Forms;
using System.Data.SQLite;
using System.Threading.Tasks;
using System.Text;
using System.Collections.Generic;
using System.Net.Http;
using Newtonsoft.Json;
using System.Linq;

namespace MindTrack
{
    /// <summary>
    /// Geli≈ümi≈ü AI Tavsiye Formu - Modern tasarƒ±m ve √ßoklu analiz se√ßenekleri
    /// </summary>
    public partial class AiAdviceForm : Form
    {
        // Ana kontroller
        private Panel headerPanel;
        private Panel contentPanel;
        private Panel buttonPanel;
        private Panel sidePanel;
        
        // Header kontrolleri
        private Label titleLabel;
        private Label subtitleLabel;
        private PictureBox aiIcon;
        
        // Content kontrolleri
        private RichTextBox adviceDisplay;
        private ProgressBar loadingBar;
        private Label statusLabel;
        
        // Button kontrolleri
        private Button btnFullAnalysis;
        private Button btnMoodOnly;
        private Button btnTaskFocus;
        private Button btnMotivation;
        private Button btnSaveAdvice;
        private Button btnClose;
        
        // Side panel kontrolleri
        private GroupBox moodBox;
        private GroupBox taskBox;
        private Label currentMoodLabel;
        private Label taskCountLabel;
        private ListView recentTasksList;
        
        // Veri alanlarƒ±
        private readonly DateTime selectedDate;
        private readonly string connectionString;
        private string lastAdvice = "";
        private string currentMood = "";
        private List<string> todayTasks = new List<string>();

        public AiAdviceForm(DateTime selectedDate)
        {
            InitializeComponent();
            this.selectedDate = selectedDate;
            connectionString = $"Data Source={System.IO.Path.Combine(Application.StartupPath, "Database", "mindtrack.db")};Version=3;";
            
            InitializeModernUI();
            LoadUserDataAsync();
        }

        /// <summary>
        /// Modern ve kullanƒ±cƒ± dostu aray√ºz tasarƒ±mƒ±
        /// </summary>
        private void InitializeModernUI()
        {
            // Form ayarlarƒ±
            this.Text = "MindTrack AI Asistan";
            this.Size = new Size(1000, 700);
            this.MinimumSize = new Size(800, 600);
            this.StartPosition = FormStartPosition.CenterParent;
            this.BackColor = Color.FromArgb(245, 247, 250);
            this.FormBorderStyle = FormBorderStyle.FixedDialog;
            this.MaximizeBox = false;

            CreateHeaderPanel();
            CreateSidePanel();
            CreateContentPanel();
            CreateButtonPanel();
            
            // Panelleri forma ekle
            this.Controls.Add(headerPanel);
            this.Controls.Add(sidePanel);
            this.Controls.Add(contentPanel);
            this.Controls.Add(buttonPanel);
        }

        /// <summary>
        /// √úst ba≈ülƒ±k panelini olu≈üturur
        /// </summary>
        private void CreateHeaderPanel()
        {
            headerPanel = new Panel
            {
                Dock = DockStyle.Top,
                Height = 80,
                BackColor = Color.FromArgb(0, 120, 212),
                Padding = new Padding(20, 10, 20, 10)
            };

            // AI ikonu
            aiIcon = new PictureBox
            {
                Size = new Size(50, 50),
                Location = new Point(20, 15),
                BackColor = Color.White,
                SizeMode = PictureBoxSizeMode.CenterImage
            };
            
            // Basit AI ikonu √ßizimi
            aiIcon.Paint += (s, e) =>
            {
                e.Graphics.FillEllipse(Brushes.LightBlue, 10, 10, 30, 30);
                e.Graphics.DrawString("AI", new Font("Segoe UI", 12, FontStyle.Bold), Brushes.DarkBlue, 17, 20);
            };

            // Ana ba≈ülƒ±k
            titleLabel = new Label
            {
                Text = "MindTrack AI Asistan",
                Location = new Point(80, 15),
                Size = new Size(300, 30),
                Font = new Font("Segoe UI", 16, FontStyle.Bold),
                ForeColor = Color.White,
                BackColor = Color.Transparent
            };

            // Alt ba≈ülƒ±k
            subtitleLabel = new Label
            {
                Text = $"Ki≈üiselle≈ütirilmi≈ü analiz ve tavsiyeler - {selectedDate.ToString("dd MMMM yyyy")}",
                Location = new Point(80, 45),
                Size = new Size(400, 20),
                Font = new Font("Segoe UI", 10),
                ForeColor = Color.FromArgb(220, 220, 220),
                BackColor = Color.Transparent
            };

            headerPanel.Controls.AddRange(new Control[] { aiIcon, titleLabel, subtitleLabel });
        }

        /// <summary>
        /// Yan bilgi panelini olu≈üturur
        /// </summary>
        private void CreateSidePanel()
        {
            sidePanel = new Panel
            {
                Dock = DockStyle.Right,
                Width = 280,
                BackColor = Color.White,
                Padding = new Padding(15)
            };

            // Ruh hali kutusu
            moodBox = new GroupBox
            {
                Text = "Mevcut Ruh Hali",
                Location = new Point(15, 15),
                Size = new Size(250, 80),
                Font = new Font("Segoe UI", 10, FontStyle.Bold),
                ForeColor = Color.FromArgb(51, 51, 51)
            };

            currentMoodLabel = new Label
            {
                Text = "Y√ºkleniyor...",
                Location = new Point(10, 25),
                Size = new Size(230, 40),
                Font = new Font("Segoe UI", 12),
                ForeColor = Color.FromArgb(0, 120, 212),
                TextAlign = ContentAlignment.MiddleCenter,
                BorderStyle = BorderStyle.FixedSingle,
                BackColor = Color.FromArgb(248, 249, 250)
            };

            moodBox.Controls.Add(currentMoodLabel);

            // G√∂rev kutusu
            taskBox = new GroupBox
            {
                Text = "Bug√ºn√ºn G√∂revleri",
                Location = new Point(15, 105),
                Size = new Size(250, 300),
                Font = new Font("Segoe UI", 10, FontStyle.Bold),
                ForeColor = Color.FromArgb(51, 51, 51)
            };

            taskCountLabel = new Label
            {
                Text = "G√∂revler y√ºkleniyor...",
                Location = new Point(10, 25),
                Size = new Size(230, 25),
                Font = new Font("Segoe UI", 9),
                ForeColor = Color.Gray,
                TextAlign = ContentAlignment.MiddleCenter
            };

            recentTasksList = new ListView
            {
                Location = new Point(10, 55),
                Size = new Size(230, 235),
                View = View.Details,
                FullRowSelect = true,
                GridLines = true,
                Font = new Font("Segoe UI", 9),
                HeaderStyle = ColumnHeaderStyle.None,
                BorderStyle = BorderStyle.FixedSingle
            };
            
            recentTasksList.Columns.Add("G√∂rev", 180);
            recentTasksList.Columns.Add("Durum", 50);

            taskBox.Controls.AddRange(new Control[] { taskCountLabel, recentTasksList });

            sidePanel.Controls.AddRange(new Control[] { moodBox, taskBox });
        }

        /// <summary>
        /// Ana i√ßerik panelini olu≈üturur
        /// </summary>
        private void CreateContentPanel()
        {
            contentPanel = new Panel
            {
                Dock = DockStyle.Fill,
                BackColor = Color.White,
                Padding = new Padding(20)
            };

            // Durum etiketi
            statusLabel = new Label
            {
                Text = "AI asistanƒ±nƒ±z hazƒ±rlanƒ±yor...",
                Location = new Point(20, 20),
                Size = new Size(400, 25),
                Font = new Font("Segoe UI", 10),
                ForeColor = Color.Gray
            };

            // Y√ºkleme √ßubuƒüu
            loadingBar = new ProgressBar
            {
                Location = new Point(20, 50),
                Size = new Size(400, 10),
                Style = ProgressBarStyle.Marquee,
                MarqueeAnimationSpeed = 30,
                Visible = false
            };

            // Tavsiye g√∂r√ºnt√ºleme alanƒ±
            adviceDisplay = new RichTextBox
            {
                Location = new Point(20, 70),
                Size = new Size(650, 400),
                ReadOnly = true,
                Font = new Font("Segoe UI", 11),
                BackColor = Color.FromArgb(250, 250, 250),
                BorderStyle = BorderStyle.FixedSingle,
                ScrollBars = RichTextBoxScrollBars.Vertical,
                Text = "Merhaba! Ben MindTrack AI asistanƒ±nƒ±zƒ±m. ü§ñ\n\n" +
                       "Size ki≈üiselle≈ütirilmi≈ü tavsiyeler sunmak i√ßin buradayƒ±m. " +
                       "A≈üaƒüƒ±daki butonlardan birini se√ßerek ba≈ülayabilirsiniz:\n\n" +
                       "‚Ä¢ üîç Tam Analiz: Ruh haliniz ve g√∂revlerinizi birlikte analiz eder\n" +
                       "‚Ä¢ üòä Sadece Ruh Hali: Duygusal durumunuza odaklanƒ±r\n" +
                       "‚Ä¢ üìã G√∂rev Odaklƒ±: G√∂revleriniz i√ßin stratejik √∂neriler\n" +
                       "‚Ä¢ ‚ö° Motivasyon: Hƒ±zlƒ± motivasyon ve cesaret verici s√∂zler"
            };

            contentPanel.Controls.AddRange(new Control[] { statusLabel, loadingBar, adviceDisplay });
        }

        /// <summary>
        /// Alt buton panelini olu≈üturur
        /// </summary>
        private void CreateButtonPanel()
        {
            buttonPanel = new Panel
            {
                Dock = DockStyle.Bottom,
                Height = 80,
                BackColor = Color.FromArgb(248, 249, 250),
                Padding = new Padding(20, 15, 20, 15)
            };

            // Analiz butonlarƒ±
            btnFullAnalysis = CreateStyledButton("üîç Tam Analiz", new Point(20, 15), Color.FromArgb(0, 120, 212));
            btnMoodOnly = CreateStyledButton("üòä Sadece Ruh Hali", new Point(160, 15), Color.FromArgb(108, 117, 125));
            btnTaskFocus = CreateStyledButton("üìã G√∂rev Odaklƒ±", new Point(300, 15), Color.FromArgb(40, 167, 69));
            btnMotivation = CreateStyledButton("‚ö° Motivasyon", new Point(440, 15), Color.FromArgb(255, 193, 7));

            // Yardƒ±mcƒ± butonlar
            btnSaveAdvice = CreateStyledButton("üíæ Kaydet", new Point(580, 15), Color.FromArgb(108, 117, 125));
            btnClose = CreateStyledButton("‚ùå Kapat", new Point(720, 15), Color.FromArgb(220, 53, 69));

            // Olay baƒülayƒ±cƒ±larƒ±
            btnFullAnalysis.Click += async (s, e) => await PerformAnalysis("full");
            btnMoodOnly.Click += async (s, e) => await PerformAnalysis("mood");
            btnTaskFocus.Click += async (s, e) => await PerformAnalysis("tasks");
            btnMotivation.Click += async (s, e) => await PerformAnalysis("motivation");
            btnSaveAdvice.Click += SaveAdvice_Click;
            btnClose.Click += (s, e) => this.Close();

            buttonPanel.Controls.AddRange(new Control[] { 
                btnFullAnalysis, btnMoodOnly, btnTaskFocus, btnMotivation, btnSaveAdvice, btnClose 
            });
        }

        /// <summary>
        /// Stilize edilmi≈ü buton olu≈üturur
        /// </summary>
        private Button CreateStyledButton(string text, Point location, Color backColor)
        {
            return new Button
            {
                Text = text,
                Location = location,
                Size = new Size(130, 40),
                FlatStyle = FlatStyle.Flat,
                BackColor = backColor,
                ForeColor = Color.White,
                Font = new Font("Segoe UI", 9, FontStyle.Bold),
                TextAlign = ContentAlignment.MiddleCenter,
                Cursor = Cursors.Hand
            };
        }

        /// <summary>
        /// Kullanƒ±cƒ± verilerini y√ºkler
        /// </summary>
        private async Task LoadUserDataAsync()
        {
            try
            {
                using (var conn = new SQLiteConnection(connectionString))
                {
                    await conn.OpenAsync();

                    // Ruh hali verisi
                    using (var cmd = new SQLiteCommand(
                        "SELECT Mood FROM MoodEntries WHERE date(Timestamp) = @date ORDER BY Timestamp DESC LIMIT 1",
                        conn))
                    {
                        cmd.Parameters.AddWithValue("@date", selectedDate.ToString("yyyy-MM-dd"));
                        var result = await cmd.ExecuteScalarAsync();
                        currentMood = result?.ToString() ?? "Belirtilmemi≈ü";
                        
                        currentMoodLabel.Text = GetMoodEmoji(currentMood) + " " + currentMood;
                        currentMoodLabel.BackColor = GetMoodColor(currentMood);
                    }

                    // G√∂rev verileri
                    using (var cmd = new SQLiteCommand(
                        "SELECT Title, Status FROM Tasks WHERE Date = @date ORDER BY Id",
                        conn))
                    {
                        cmd.Parameters.AddWithValue("@date", selectedDate.ToString("yyyy-MM-dd"));
                        using (var reader = await cmd.ExecuteReaderAsync())
                        {
                            todayTasks.Clear();
                            recentTasksList.Items.Clear();
                            
                            int completedCount = 0;
                            int totalCount = 0;
                            
                            while (await reader.ReadAsync())
                            {
                                string title = reader["Title"].ToString();
                                string status = reader["Status"].ToString();
                                
                                todayTasks.Add(title);
                                totalCount++;
                                
                                if (status.ToLower() == "completed")
                                    completedCount++;

                                var item = new ListViewItem(title);
                                item.SubItems.Add(GetStatusEmoji(status));
                                
                                // Duruma g√∂re renk
                                if (status.ToLower() == "completed")
                                    item.ForeColor = Color.Green;
                                else if (status.ToLower() == "in progress")
                                    item.ForeColor = Color.Orange;
                                else
                                    item.ForeColor = Color.Black;
                                
                                recentTasksList.Items.Add(item);
                            }
                            
                            taskCountLabel.Text = $"Toplam: {totalCount} | Tamamlanan: {completedCount}";
                        }
                    }
                }

                statusLabel.Text = "Veriler y√ºklendi. Analiz i√ßin bir se√ßenek se√ßin.";
            }
            catch (Exception ex)
            {
                statusLabel.Text = "Veri y√ºkleme hatasƒ±: " + ex.Message;
                currentMoodLabel.Text = "Hata";
                taskCountLabel.Text = "G√∂revler y√ºklenemedi";
            }
        }

        /// <summary>
        /// Se√ßilen analiz t√ºr√ºn√º ger√ßekle≈ütirir
        /// </summary>
        private async Task PerformAnalysis(string analysisType)
        {
            try
            {
                // UI'yi g√ºncelle
                loadingBar.Visible = true;
                loadingBar.Style = ProgressBarStyle.Marquee;
                
                // Butonlarƒ± devre dƒ±≈üƒ± bƒ±rak
                SetButtonsEnabled(false);

                string prompt = "";
                string statusText = "";

                switch (analysisType)
                {
                    case "full":
                        statusText = "Tam analiz ger√ßekle≈ütiriliyor...";
                        prompt = CreateFullAnalysisPrompt();
                        break;
                    case "mood":
                        statusText = "Ruh hali analizi yapƒ±lƒ±yor...";
                        prompt = CreateMoodAnalysisPrompt();
                        break;
                    case "tasks":
                        statusText = "G√∂rev odaklƒ± analiz yapƒ±lƒ±yor...";
                        prompt = CreateTaskAnalysisPrompt();
                        break;
                    case "motivation":
                        statusText = "Motivasyon mesajƒ± olu≈üturuluyor...";
                        prompt = CreateMotivationPrompt();
                        break;
                }

                statusLabel.Text = statusText;

                // AI'dan yanƒ±t al
                string response = await GetAIResponseAsync(prompt);
                
                if (!string.IsNullOrEmpty(response))
                {
                    lastAdvice = response;
                    DisplayFormattedAdvice(response, analysisType);
                    statusLabel.Text = $"Analiz tamamlandƒ± - {DateTime.Now.ToString("HH:mm:ss")}";
                }
                else
                {
                    adviceDisplay.Text = "√úzg√ºn√ºm, ≈üu anda analiz yapamƒ±yorum. L√ºtfen daha sonra tekrar deneyin.";
                    statusLabel.Text = "Analiz ba≈üarƒ±sƒ±z";
                }
            }
            catch (Exception ex)
            {
                adviceDisplay.Text = $"Hata olu≈ütu: {ex.Message}";
                statusLabel.Text = "Analiz hatasƒ±";
            }
            finally
            {
                loadingBar.Visible = false;
                SetButtonsEnabled(true);
            }
        }

        /// <summary>
        /// Tam analiz prompt'u olu≈üturur
        /// </summary>
        private string CreateFullAnalysisPrompt()
        {
            return $@"
Sen MindTrack AI asistanƒ±sƒ±n. Kullanƒ±cƒ±nƒ±n ruh hali ve g√∂revlerini analiz ederek ki≈üiselle≈ütirilmi≈ü tavsiyeler ver.

KULLANICI VERƒ∞LERƒ∞:
üìÖ Tarih: {selectedDate.ToString("dd MMMM yyyy")}
üòä Ruh Hali: {currentMood}
üìã G√∂revler: {string.Join(", ", todayTasks)}

G√ñREV:
1. Ruh hali ve g√∂rev uyumunu analiz et
2. Ki≈üiselle≈ütirilmi≈ü √∂neriler sun
3. Motivasyon ve destek ver
4. Pratik adƒ±mlar √∂ner

Yanƒ±tƒ±nƒ± ≈üu formatta ver:
üîç GENEL DURUM ANALƒ∞Zƒ∞
[Kƒ±sa analiz]

üí° Kƒ∞≈ûƒ∞SELLE≈ûTƒ∞Rƒ∞LMƒ∞≈û TAVSƒ∞YELER
[3-4 madde halinde]

‚ö° BUG√úN ƒ∞√áƒ∞N EYLEM PLANI
[Somut adƒ±mlar]

üåü MOTƒ∞VASYON MESAJI
[Cesaret verici s√∂zler]
";
        }

        /// <summary>
        /// Ruh hali analizi prompt'u olu≈üturur
        /// </summary>
        private string CreateMoodAnalysisPrompt()
        {
            return $@"
Sen MindTrack AI asistanƒ±sƒ±n. Kullanƒ±cƒ±nƒ±n ruh halini derinlemesine analiz et.

KULLANICI VERƒ∞Sƒ∞:
üìÖ Tarih: {selectedDate.ToString("dd MMMM yyyy")}
üòä Ruh Hali: {currentMood}

G√ñREV:
1. Ruh halini yorumla
2. Duygusal destek ver
3. ƒ∞yile≈ütirme √∂nerileri sun
4. Pozitif bakƒ±≈ü a√ßƒ±sƒ± geli≈ütir

Yanƒ±tƒ±nƒ± ≈üu formatta ver:
üòä RUH HALƒ∞ ANALƒ∞Zƒ∞
[Duygusal durum yorumu]

üíö DUYGUSAL DESTEK
[Anlayƒ±≈ü ve empati]

üåà ƒ∞Yƒ∞LE≈ûTƒ∞RME √ñNERƒ∞LERƒ∞
[Pratik √∂neriler]

‚ú® POZƒ∞Tƒ∞F MESAJ
[Umut verici s√∂zler]
";
        }

        /// <summary>
        /// G√∂rev analizi prompt'u olu≈üturur
        /// </summary>
        private string CreateTaskAnalysisPrompt()
        {
            return $@"
Sen MindTrack AI asistanƒ±sƒ±n. Kullanƒ±cƒ±nƒ±n g√∂revlerini analiz ederek verimlilik √∂nerileri ver.

KULLANICI VERƒ∞Sƒ∞:
üìÖ Tarih: {selectedDate.ToString("dd MMMM yyyy")}
üìã G√∂revler: {string.Join(", ", todayTasks)}

G√ñREV:
1. G√∂rev listesini analiz et
2. √ñnceliklendirme √∂ner
3. Verimlilik stratejileri sun
4. Zaman y√∂netimi tavsiyeleri ver

Yanƒ±tƒ±nƒ± ≈üu formatta ver:
üìã G√ñREV ANALƒ∞Zƒ∞
[G√∂rev durumu deƒüerlendirmesi]

üéØ √ñNCELƒ∞KLENDƒ∞RME
[Hangi g√∂revler √∂nce]

‚ö° VERƒ∞MLƒ∞Lƒ∞K STRATEJƒ∞LERƒ∞
[Pratik y√∂ntemler]

‚è∞ ZAMAN Y√ñNETƒ∞Mƒ∞
[Zaman planlamasƒ± √∂nerileri]
";
        }

        /// <summary>
        /// Motivasyon prompt'u olu≈üturur
        /// </summary>
        private string CreateMotivationPrompt()
        {
            return $@"
Sen MindTrack AI asistanƒ±sƒ±n. Kullanƒ±cƒ±ya g√º√ßl√º motivasyon ve cesaret ver.

KULLANICI VERƒ∞Sƒ∞:
üìÖ Tarih: {selectedDate.ToString("dd MMMM yyyy")}
üòä Ruh Hali: {currentMood}

G√ñREV:
1. G√º√ßl√º motivasyon ver
2. √ñzg√ºven artƒ±r
3. Pozitif enerji yay
4. ƒ∞lham verici ol

Yanƒ±tƒ±nƒ± ≈üu formatta ver:
‚ö° G√úNL√úK MOTƒ∞VASYON
[G√º√ßl√º motivasyon mesajƒ±]

üí™ √ñZG√úVEN ARTIRICI
[G√º√ß verici s√∂zler]

üåü ƒ∞LHAM VERƒ∞Cƒ∞ D√ú≈û√úNCELER
[ƒ∞lham verici alƒ±ntƒ±lar]

üöÄ BA≈ûARI MESAJI
[Ba≈üarƒ±ya odaklƒ± mesaj]
";
        }

        /// <summary>
        /// AI'dan yanƒ±t alƒ±r
        /// </summary>
        private async Task<string> GetAIResponseAsync(string prompt)
        {
            try
            {
                var payload = new
                {
                    messages = new[]
                    {
                        new { role = "user", content = prompt }
                    },
                    temperature = 0.7,
                    max_tokens = 1000
                };

                using (var client = new HttpClient())
                {
                    client.Timeout = TimeSpan.FromSeconds(30);
                    var json = JsonConvert.SerializeObject(payload);
                    var content = new StringContent(json, Encoding.UTF8, "application/json");
                    
                    var response = await client.PostAsync("http://localhost:1234/v1/chat/completions", content);
                    response.EnsureSuccessStatusCode();
                    
                    var result = await response.Content.ReadAsStringAsync();
                    dynamic obj = JsonConvert.DeserializeObject(result);
                    return obj.choices[0].message.content.ToString();
                }
            }
            catch (Exception ex)
            {
                return $"AI baƒülantƒ± hatasƒ±: {ex.Message}";
            }
        }

        /// <summary>
        /// Formatlanmƒ±≈ü tavsiyeyi g√∂r√ºnt√ºler
        /// </summary>
        private void DisplayFormattedAdvice(string advice, string analysisType)
        {
            adviceDisplay.Clear();
            
            // Ba≈ülƒ±k ekle
            string title = analysisType switch
            {
                "full" => "üîç TAM ANALƒ∞Z SONU√áLARI",
                "mood" => "üòä RUH HALƒ∞ ANALƒ∞Zƒ∞",
                "tasks" => "üìã G√ñREV ANALƒ∞Zƒ∞",
                "motivation" => "‚ö° MOTƒ∞VASYON MESAJINIZ",
                _ => "ü§ñ AI TAVSƒ∞YELERƒ∞"
            };

            adviceDisplay.SelectionFont = new Font("Segoe UI", 14, FontStyle.Bold);
            adviceDisplay.SelectionColor = Color.FromArgb(0, 120, 212);
            adviceDisplay.AppendText(title + "\n");
            adviceDisplay.AppendText("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n");

            // Ana i√ßeriƒüi ekle
            adviceDisplay.SelectionFont = new Font("Segoe UI", 11);
            adviceDisplay.SelectionColor = Color.Black;
            adviceDisplay.AppendText(advice);

            // Alt bilgi ekle
            adviceDisplay.AppendText("\n\n");
            adviceDisplay.SelectionFont = new Font("Segoe UI", 9, FontStyle.Italic);
            adviceDisplay.SelectionColor = Color.Gray;
            adviceDisplay.AppendText($"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n");
            adviceDisplay.AppendText($"Olu≈üturulma: {DateTime.Now.ToString("dd MMMM yyyy HH:mm:ss")}\n");
            adviceDisplay.AppendText($"MindTrack AI Asistanƒ± tarafƒ±ndan ki≈üiselle≈ütirildi");
        }

        /// <summary>
        /// Tavsiyeyi kaydetme i≈ülemi
        /// </summary>
        private void SaveAdvice_Click(object sender, EventArgs e)
        {
            if (string.IsNullOrEmpty(lastAdvice))
            {
                MessageBox.Show("Kaydedilecek tavsiye bulunamadƒ±.", "Uyarƒ±", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }

            try
            {
                using (var saveDialog = new SaveFileDialog())
                {
                    saveDialog.Filter = "Metin Dosyasƒ± (*.txt)|*.txt|T√ºm Dosyalar (*.*)|*.*";
                    saveDialog.FileName = $"MindTrack_Tavsiye_{DateTime.Now.ToString("yyyyMMdd_HHmmss")}.txt";
                    
                    if (saveDialog.ShowDialog() == DialogResult.OK)
                    {
                        string content = $"MindTrack AI Tavsiyesi\n";
                        content += $"Tarih: {selectedDate.ToString("dd MMMM yyyy")}\n";
                        content += $"Olu≈üturulma: {DateTime.Now.ToString("dd MMMM yyyy HH:mm:ss")}\n";
                        content += $"Ruh Hali: {currentMood}\n";
                        content += $"G√∂rev Sayƒ±sƒ±: {todayTasks.Count}\n\n";
                        content += "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n";
                        content += lastAdvice;
                        
                        System.IO.File.WriteAllText(saveDialog.FileName, content, Encoding.UTF8);
                        MessageBox.Show("Tavsiye ba≈üarƒ±yla kaydedildi!", "Ba≈üarƒ±lƒ±", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Kaydetme hatasƒ±: {ex.Message}", "Hata", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        /// <summary>
        /// Butonlarƒ± etkinle≈ütir/devre dƒ±≈üƒ± bƒ±rak
        /// </summary>
        private void SetButtonsEnabled(bool enabled)
        {
            btnFullAnalysis.Enabled = enabled;
            btnMoodOnly.Enabled = enabled;
            btnTaskFocus.Enabled = enabled;
            btnMotivation.Enabled = enabled;
        }

        /// <summary>
        /// Ruh haline g√∂re emoji d√∂nd√ºr√ºr
        /// </summary>
        private string GetMoodEmoji(string mood)
        {
            return mood.ToLower() switch
            {
                "mutlu" or "happy" => "üòä",
                "√ºzg√ºn" or "sad" => "üò¢",
                "stresli" or "stressed" => "üò∞",
                "sakin" or "calm" => "üòå",
                "enerjik" or "energetic" => "‚ö°",
                "yorgun" or "tired" => "üò¥",
                "sinirli" or "angry" => "üò†",
                "heyecanlƒ±" or "excited" => "ü§©",
                _ => "üòê"
            };
        }

        /// <summary>
        /// Ruh haline g√∂re renk d√∂nd√ºr√ºr
        /// </summary>
        private Color GetMoodColor(string mood)
        {
            return mood.ToLower() switch
            {
                "mutlu" or "happy" => Color.FromArgb(255, 248, 220),
                "√ºzg√ºn" or "sad" => Color.FromArgb(230, 240, 255),
                "stresli" or "stressed" => Color.FromArgb(255, 235, 235),
                "sakin" or "calm" => Color.FromArgb(240, 255, 240),
                "enerjik" or "energetic" => Color.FromArgb(255, 250, 205),
                "yorgun" or "tired" => Color.FromArgb(245, 245, 245),
                "sinirli" or "angry" => Color.FromArgb(255, 220, 220),
                "heyecanlƒ±" or "excited" => Color.FromArgb(255, 240, 255),
                _ => Color.FromArgb(248, 249, 250)
            };
        }

        /// <summary>
        /// G√∂rev durumuna g√∂re emoji d√∂nd√ºr√ºr
        /// </summary>
        private string GetStatusEmoji(string status)
        {
            return status.ToLower() switch
            {
                "completed" => "‚úÖ",
                "in progress" => "üîÑ",
                "pending" => "‚è≥",
                _ => "üìù"
            };
        }
    }
} 